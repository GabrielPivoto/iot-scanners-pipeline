name: IoT Security Scan (Docker Environment)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  iot-security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Docker Compose
        run: |
          cd pyotest
          docker compose up -d
          cd ..
          sleep 20  

      - name: Install scanners
        run: |
          sudo apt-get update
          sudo apt-get install -y nikto wapiti nmap

      # ------------------ NIKTO -------------------
      - name: Run Nikto (Traversal HTTP)
        run: |
          chmod +x scanners_scripts/run_nikto.sh
          ./scanners_scripts/run_nikto.sh http://localhost:8080

      - name: Run Nikto (Admin Panel)
        run: |
          ./scanners_scripts/run_nikto.sh http://localhost:8081

      # ------------------ WAPITI -------------------
      - name: Run Wapiti (Traversal)
        run: |
          chmod +x scanners_scripts/run_wapiti.sh
          ./scanners_scripts/run_wapiti.sh http://localhost:8080

      - name: Run Wapiti (Admin Panel)
        run: |
          ./scanners_scripts/run_wapiti.sh http://localhost:8081

      - name: Run Wapiti (DVWA)
        run: |
          wapiti -u "http://localhost:8083/vulnerabilities/sqli/?id=1&Submit=Submit#" \
          --level=2 \
          --scope url \
          -o wapiti_report --format html

      # ------------------ NMAP -------------------
      - name: Run Nmap (Multiple Ports)
        run: |
          chmod +x scanners_scripts/run_nmap.sh
          ./scanners_scripts/run_nmap.sh "localhost -p 8080,8081,8082,2121,2122,2323,2222,1883"

      # ------------------ INTERNAL SCANNER -------------------
      - name: Run internal scanner container
        run: |
          mkdir -p pyotest/report
          cd pyotest
          docker compose run scanner
          cd ..

      # ------------------ EXPORT REPORTS -------------------
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: scanner-reports
          path: |
            nikto_report.html
            wapiti_report/
            nmap_report.txt
            pyotest/report/

      - name: Shutdown containers
        if: always()
        run: |
          cd pyotest
          docker compose down -v